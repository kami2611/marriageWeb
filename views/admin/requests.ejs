<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Requests Management - D'amour Muslim Admin</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="manifest" href="/images/site.webmanifest">
  <meta name="theme-color" content="#E91E63">
  <link rel="stylesheet" href="/css/output.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Playfair+Display:wght@400;600;700&family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
  <style>
    .material-shadow {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .material-shadow-hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .gradient-bg {
      background: linear-gradient(135deg, #E91E63 0%, #673AB7 100%);
    }

    .status-badge {
      transition: all 0.3s ease;
    }

    .request-card {
      transition: all 0.3s ease;
    }

    .request-card:hover {
      transform: translateY(-1px);
    }
  </style>
</head>

<body class="bg-gray-50 font-['Roboto']">
  <header class="fixed top-0 left-0 right-0 bg-white material-shadow z-50">
    <div class="flex items-center justify-between px-6 h-16">
      <div class="flex items-center">
        <h1 class="text-2xl font-bold text-primary font-['Playfair_Display']">
          <a href="/admin/dashboard" class="hover:text-pink-600 transition-colors duration-300 cursor-pointer">
            D'amour Muslim
          </a>
        </h1>
        <span class="ml-4 px-3 py-1 bg-secondary/10 text-secondary text-sm rounded-full font-medium">Requests</span>
      </div>
      <div class="flex items-center gap-4">
        <a href="/admin/dashboard" class="px-4 py-2 text-gray-600 hover:text-primary transition-colors duration-300">
          <i class="ri-arrow-left-line mr-2"></i>Back to Dashboard
        </a>
        <button id="logoutBtn" class="px-6 py-2 border-2 border-red-500 text-red-500 hover:bg-red-500 hover:text-white transition-all duration-300 !rounded-button whitespace-nowrap">
          <i class="ri-logout-box-line mr-2"></i>Logout
        </button>
      </div>
    </div>
  </header>

  <main class="pt-24 pb-16 min-h-screen">
    <div class="max-w-7xl mx-auto px-6">
      <!-- Page Header -->
      <div class="bg-white rounded-2xl p-6 material-shadow mb-8">
        <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Requests Management</h2>
            <p class="text-gray-600">Manage all user connection requests</p>
          </div>
          <div class="flex items-center gap-4">
            <!-- Filter Dropdown -->
            <div class="relative">
              <select id="statusFilter" class="px-4 py-2.5 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary bg-white text-gray-900">
                <option value="all" <%= currentFilter === 'all' ? 'selected' : '' %>>All Requests</option>
                <option value="pending" <%= currentFilter === 'pending' ? 'selected' : '' %>>Pending</option>
                <option value="accepted" <%= currentFilter === 'accepted' ? 'selected' : '' %>>Accepted</option>
                <option value="rejected" <%= currentFilter === 'rejected' ? 'selected' : '' %>>Rejected</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl p-6 material-shadow">
          <div class="flex items-center">
            <div class="w-12 h-12 flex items-center justify-center rounded-full bg-blue-100 text-blue-600">
              <i class="ri-mail-line text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm text-gray-500">Total Requests</p>
              <p class="text-2xl font-bold text-gray-900"><%= stats.total %></p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 material-shadow">
          <div class="flex items-center">
            <div class="w-12 h-12 flex items-center justify-center rounded-full bg-yellow-100 text-yellow-600">
              <i class="ri-time-line text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm text-gray-500">Pending</p>
              <p class="text-2xl font-bold text-gray-900"><%= stats.pending %></p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 material-shadow">
          <div class="flex items-center">
            <div class="w-12 h-12 flex items-center justify-center rounded-full bg-green-100 text-green-600">
              <i class="ri-check-line text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm text-gray-500">Accepted</p>
              <p class="text-2xl font-bold text-gray-900"><%= stats.accepted %></p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 material-shadow">
          <div class="flex items-center">
            <div class="w-12 h-12 flex items-center justify-center rounded-full bg-red-100 text-red-600">
              <i class="ri-close-line text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm text-gray-500">Rejected</p>
              <p class="text-2xl font-bold text-gray-900"><%= stats.rejected %></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Requests List -->
      <div class="bg-white rounded-2xl material-shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <%= currentFilter === 'all' ? 'All Requests' : currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1) + ' Requests' %>
            <span class="text-sm text-gray-500 font-normal">(<%= requests.length %> found)</span>
          </h3>
        </div>

        <% if (requests && requests.length > 0) { %>
        <div class="divide-y divide-gray-200">
          <% requests.forEach(request => { %>
          <div class="request-card p-6 hover:bg-gray-50">
            <div class="flex items-center justify-between">
              <!-- Request Info -->
              <div class="flex-1">
                <div class="flex items-center gap-4 mb-3">
                  <!-- From User - **CLICKABLE** -->
                  <div class="flex items-center gap-3 cursor-pointer hover:bg-blue-50 p-2 rounded-lg transition-colors duration-200 view-profile-clickable" data-user-slug="<%= request.from?.profileSlug %>" title="Click to view <%= request.from?.name || request.from?.username %>'s Profile">
                    <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center">
                      <i class="ri-user-line text-primary"></i>
                    </div>
                    <div>
                      <p class="font-semibold text-gray-900">
                        <%= request.from?.name || request.from?.username || 'Unknown' %>
                      </p>
                      <p class="text-sm text-gray-600">
                        @<%= request.from?.username || 'unknown' %> •
                        <%= request.from?.age ? request.from.age + ' yrs' : 'Age N/A' %> •
                        <%= request.from?.gender?.charAt(0)?.toUpperCase() + request.from?.gender?.slice(1) || 'Gender N/A' %>
                      </p>
                      <p class="text-xs text-gray-500">
                        <%= request.from?.city ? request.from.city + ', ' : '' %><%= request.from?.country || 'Location N/A' %>
                      </p>
                    </div>
                  </div>

                  <!-- Arrow -->
                  <div class="px-3">
                    <i class="ri-arrow-right-line text-gray-400 text-xl"></i>
                  </div>

                  <!-- To User - **CLICKABLE** -->
                  <div class="flex items-center gap-3 cursor-pointer hover:bg-purple-50 p-2 rounded-lg transition-colors duration-200 view-profile-clickable" data-user-slug="<%= request.to?.profileSlug %>" title="Click to view <%= request.to?.name || request.to?.username %>'s Profile">
                    <div class="w-10 h-10 bg-secondary/10 rounded-full flex items-center justify-center">
                      <i class="ri-user-line text-secondary"></i>
                    </div>
                    <div>
                      <p class="font-semibold text-gray-900">
                        <%= request.to?.name || request.to?.username || 'Unknown' %>
                      </p>
                      <p class="text-sm text-gray-600">
                        @<%= request.to?.username || 'unknown' %> •
                        <%= request.to?.age ? request.to.age + ' yrs' : 'Age N/A' %> •
                        <%= request.to?.gender?.charAt(0)?.toUpperCase() + request.to?.gender?.slice(1) || 'Gender N/A' %>
                      </p>
                      <p class="text-xs text-gray-500">
                        <%= request.to?.city ? request.to.city + ', ' : '' %><%= request.to?.country || 'Location N/A' %>
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Request Meta -->
                <div class="flex items-center gap-4 text-sm text-gray-500">
                  <div class="flex items-center gap-1">
                    <i class="ri-time-line"></i>
                    <span>
                      <%= request.createdAt ? new Date(request.createdAt).toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      }) : 'Date N/A' %>
                    </span>
                  </div>
                  <div class="flex items-center gap-1">
                    <i class="ri-fingerprint-line"></i>
                    <span class="font-mono text-xs">ID: <%= request._id.toString().substring(0, 8) %>...</span>
                  </div>
                </div>
              </div>

              <!-- Status & Actions -->
              <div class="flex items-center gap-4">
                <!-- Status Badge -->
                <div>
                  <% 
                    let statusClass = 'bg-gray-100 text-gray-600';
                    let statusIcon = 'ri-question-line';
                    
                    if (request.status === 'pending') {
                      statusClass = 'bg-yellow-100 text-yellow-600';
                      statusIcon = 'ri-time-line';
                    } else if (request.status === 'accepted') {
                      statusClass = 'bg-green-100 text-green-600';
                      statusIcon = 'ri-check-line';
                    } else if (request.status === 'rejected') {
                      statusClass = 'bg-red-100 text-red-600';
                      statusIcon = 'ri-close-line';
                    }
                  %>
                  <span class="status-badge px-3 py-1 <%= statusClass %> text-sm rounded-full font-medium inline-flex items-center gap-1">
                    <i class="<%= statusIcon %>"></i>
                    <%= request.status.charAt(0).toUpperCase() + request.status.slice(1) %>
                  </span>
                </div>

                <!-- **UPDATED**: Request Action Buttons -->
                <div class="flex gap-2">
                  <% if (request.status === 'pending') { %>
                  <!-- Pending: Show Accept/Reject/Delete -->
                  <button class="accept-btn px-3 py-2 bg-green-500 text-white hover:bg-green-600 transition-all duration-300 !rounded-button text-sm" data-request-id="<%= request._id %>" title="Accept Request">
                    <i class="ri-check-line mr-1"></i>Accept
                  </button>
                  <button class="reject-btn px-3 py-2 bg-red-500 text-white hover:bg-red-600 transition-all duration-300 !rounded-button text-sm" data-request-id="<%= request._id %>" title="Reject Request">
                    <i class="ri-close-line mr-1"></i>Reject
                  </button>
                  <button class="delete-btn px-3 py-2 bg-gray-800 text-white hover:bg-gray-900 transition-all duration-300 !rounded-button text-sm" data-request-id="<%= request._id %>" title="Delete Request Permanently">
                    <i class="ri-delete-bin-line mr-1"></i>Delete
                  </button>
                  <% } else if (request.status === 'accepted') { %>
                  <!-- Accepted: Show Revoke/Delete -->
                  <button class="revoke-btn px-3 py-2 bg-orange-500 text-white hover:bg-orange-600 transition-all duration-300 !rounded-button text-sm" data-request-id="<%= request._id %>" title="Revoke Acceptance">
                    <i class="ri-arrow-go-back-line mr-1"></i>Revoke
                  </button>
                  <button class="delete-btn px-3 py-2 bg-gray-800 text-white hover:bg-gray-900 transition-all duration-300 !rounded-button text-sm" data-request-id="<%= request._id %>" title="Delete Request Permanently">
                    <i class="ri-delete-bin-line mr-1"></i>Delete
                  </button>
                  <% } else { %>
                  <!-- Rejected: Show Delete only -->
                  <button class="delete-btn px-3 py-2 bg-gray-800 text-white hover:bg-gray-900 transition-all duration-300 !rounded-button text-sm" data-request-id="<%= request._id %>" title="Delete Request Permanently">
                    <i class="ri-delete-bin-line mr-1"></i>Delete
                  </button>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
          <% }) %>
        </div>
        <% } else { %>
        <!-- No requests found -->
        <div class="text-center py-16">
          <div class="max-w-md mx-auto">
            <div class="mb-4">
              <i class="ri-mail-line text-6xl text-gray-300"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">No Requests Found</h3>
            <p class="text-gray-500 mb-6">
              <%= currentFilter === 'all' ? 'There are no requests in the system yet.' : `No ${currentFilter} requests found.` %>
            </p>
          </div>
        </div>
        <% } %>
      </div>
    </div>
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Status Filter
      const statusFilter = document.getElementById('statusFilter');
      if (statusFilter) {
        statusFilter.addEventListener('change', function() {
          const selectedStatus = this.value;
          const url = selectedStatus === 'all' ?
            '/admin/requests' :
            `/admin/requests?status=${selectedStatus}`;
          window.location.href = url;
        });
      }

      // **UPDATED**: Clickable Profile Divs
      const viewProfileDivs = document.querySelectorAll('.view-profile-clickable');
      viewProfileDivs.forEach(div => {
        div.addEventListener('click', function() {
          const userSlug = this.getAttribute('data-user-slug');
          if (userSlug) {
            window.open(`/profiles/${userSlug}`, '_blank');
          } else {
            alert('Profile not available');
          }
        });
      });

      // **UPDATED**: Request Action Buttons (Accept, Reject, Revoke, Delete)
      const actionBtns = document.querySelectorAll('.accept-btn, .reject-btn, .revoke-btn, .delete-btn');
      actionBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const requestId = this.getAttribute('data-request-id');
          let action;

          if (this.classList.contains('accept-btn')) {
            action = 'accepted';
          } else if (this.classList.contains('reject-btn')) {
            action = 'rejected';
          } else if (this.classList.contains('revoke-btn')) {
            action = 'revoke';
            // Show confirmation for revoke
            if (!confirm('Are you sure you want to revoke this accepted request? This will remove mutual access between users.')) {
              return;
            }
          } else if (this.classList.contains('delete-btn')) {
            action = 'delete';
            // Show confirmation for delete
            if (!confirm('Are you sure you want to permanently delete this request? This action cannot be undone.')) {
              return;
            }
          }

          handleRequestAction(requestId, action, this);
        });
      });

      // **UPDATED**: Handle all request actions (Accept, Reject, Revoke, Delete)
      async function handleRequestAction(requestId, action, button) {
        try {
          // Set loading state
          button.disabled = true;
          const originalText = button.innerHTML;

          if (action === 'accepted') {
            button.innerHTML = '<i class="ri-loader-4-line animate-spin mr-1"></i>Accepting...';
          } else if (action === 'rejected') {
            button.innerHTML = '<i class="ri-loader-4-line animate-spin mr-1"></i>Rejecting...';
          } else if (action === 'revoke') {
            button.innerHTML = '<i class="ri-loader-4-line animate-spin mr-1"></i>Revoking...';
          } else if (action === 'delete') {
            button.innerHTML = '<i class="ri-loader-4-line animate-spin mr-1"></i>Deleting...';
          }

          const response = await fetch(`/admin/requests/${requestId}/respond`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              action
            })
          });

          const result = await response.json();

          if (result.success) {
            // Reload page to show updated status
            window.location.reload();
          } else {
            alert('Error: ' + (result.error || 'Unknown error occurred'));
            button.disabled = false;
            button.innerHTML = originalText;
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Network error occurred');
          button.disabled = false;
          button.innerHTML = originalText;
        }
      }

      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          if (confirm('Are you sure you want to logout?')) {
            window.location.href = '/logout';
          }
        });
      }
    });
  </script>
</body>

</html>