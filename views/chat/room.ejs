<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat with <%= otherUser.username %> - D'amour Muslim</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="manifest" href="/images/site.webmanifest">
  <meta name="theme-color" content="#E91E63">
  <link rel="stylesheet" href="/css/output.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
  <style>
    :where([class^="ri-"])::before { content: "\f3c2"; }
    .material-shadow { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

    /* Chat layout – fixed header/input, scrollable messages */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 64px); /* minus main header */
    }
    .chat-header {
      flex-shrink: 0;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .chat-input-bar {
      flex-shrink: 0;
    }

    /* Message bubbles */
    .msg-bubble {
      max-width: 75%;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .msg-sent {
      background: linear-gradient(135deg, #E91E63 0%, #d81557 100%);
      color: white;
      border-radius: 18px 18px 4px 18px;
    }
    .msg-received {
      background: #f3f4f6;
      color: #1f2937;
      border-radius: 18px 18px 18px 4px;
    }

    /* WhatsApp-style ticks */
    .tick { font-size: 14px; margin-left: 4px; display: inline-flex; align-items: center; }
    .tick-sent { color: rgba(255,255,255,0.5); }
    .tick-delivered { color: rgba(255,255,255,0.7); }
    .tick-read { color: #60a5fa; }

    /* Typing indicator */
    .typing-dot {
      width: 6px; height: 6px; border-radius: 50%; background: #9ca3af;
      animation: typingBounce 1.4s infinite;
      display: inline-block;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }

    /* Scrollbar styling */
    .chat-messages::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
    .chat-messages::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
  </style>
</head>

<body class="bg-gray-50 font-['Roboto']">
  <%- include('../partials/header') %>

  <div class="chat-container pt-24">
    <!-- Chat Header -->
    <div class="chat-header bg-white material-shadow px-4 py-3 flex items-center gap-3 z-10">
      <a href="/chats" class="text-gray-500 hover:text-primary transition-colors p-1">
        <i class="ri-arrow-left-line text-xl"></i>
      </a>
      <a href="/profiles/<%= otherUser.profileSlug || otherUser._id %>" class="flex items-center gap-3 flex-1 min-w-0">
        <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-gray-200 flex-shrink-0">
          <% if (otherUser.profilePic && otherUser.profilePic.url) { %>
            <img src="<%= otherUser.profilePic.url %>" class="w-full h-full object-cover" alt="<%= otherUser.username %>">
          <% } else { %>
            <div class="w-full h-full flex items-center justify-center <%= otherUser.gender === 'female' ? 'bg-pink-100 text-pink-500' : 'bg-blue-100 text-blue-500' %>">
              <i class="ri-user-3-line text-lg"></i>
            </div>
          <% } %>
        </div>
        <div class="min-w-0">
          <h2 class="font-semibold text-gray-900 truncate text-sm"><%= otherUser.username %></h2>
          <p id="onlineStatus" class="text-xs text-gray-400">
            <% if (otherUser.city || otherUser.country) { %>
              from <%= otherUser.city %><% if (otherUser.city && otherUser.country) { %>, <% } %><%= otherUser.country %>
            <% } else { %>
              tap to view profile
            <% } %>
          </p>
        </div>
      </a>
    </div>

    <!-- Messages Area -->
    <div id="chatMessages" class="chat-messages px-4 py-4 bg-gray-50">
      <!-- Date separator example -->
      <div id="loadingMessages" class="flex justify-center py-8">
        <div class="animate-spin w-6 h-6 border-2 border-primary border-t-transparent rounded-full"></div>
      </div>
      <!-- Messages will be appended here by JS -->
    </div>

    <!-- Typing Indicator -->
    <div id="typingIndicator" class="hidden px-4 pb-1">
      <div class="inline-flex items-center gap-2 bg-gray-100 rounded-full px-3 py-1.5">
        <span class="text-xs text-gray-500"><%= otherUser.username %> is typing</span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      </div>
    </div>

    <!-- Input Bar -->
    <div class="chat-input-bar bg-white border-t border-gray-200 px-4 py-3">
      <form id="messageForm" class="flex items-end gap-2">
        <div class="flex-1 relative">
          <textarea
            id="messageInput"
            rows="1"
            maxlength="5000"
            placeholder="Type a message..."
            class="w-full resize-none rounded-2xl border border-gray-300 px-4 py-2.5 text-sm focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all max-h-32 overflow-y-auto"
          ></textarea>
        </div>
        <button
          type="submit"
          id="sendBtn"
          disabled
          class="flex-shrink-0 w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center hover:bg-pink-600 transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed"
        >
          <i class="ri-send-plane-2-fill text-lg"></i>
        </button>
      </form>
    </div>
  </div>

  <!-- Socket.io Client -->
  <script src="/socket.io/socket.io.js"></script>

  <script>
    (function() {
      // ── Config ──
      const conversationId = '<%= conversation._id %>';
      const currentUserId = '<%= currentUserId %>';
      const otherUsername = '<%= otherUser.username %>';

      // ── DOM refs ──
      const chatMessages = document.getElementById('chatMessages');
      const loadingMessages = document.getElementById('loadingMessages');
      const messageForm = document.getElementById('messageForm');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const typingIndicator = document.getElementById('typingIndicator');

      // ── Socket connection ──
      const socket = io({ transports: ['websocket', 'polling'] });

      socket.on('connect', function() {
        console.log('Socket connected:', socket.id);
        socket.emit('joinConversation', conversationId, function(resp) {
          if (resp && resp.error) {
            console.error('Join error:', resp.error);
          }
        });
      });

      // ── Load chat history ──
      async function loadHistory() {
        try {
          const res = await fetch('/api/chat/' + conversationId);
          const data = await res.json();
          loadingMessages.remove();

          if (data.success && data.messages.length > 0) {
            let lastDate = '';
            data.messages.forEach(function(msg) {
              const msgDate = new Date(msg.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
              if (msgDate !== lastDate) {
                appendDateSeparator(msgDate);
                lastDate = msgDate;
              }
              appendMessage(msg, false);
            });
            scrollToBottom();

            // Mark all as read on load
            socket.emit('messageRead', { conversationId: conversationId });
          } else {
            loadingMessages.remove();
            chatMessages.innerHTML = '<div class="text-center py-12"><div class="mb-3"><i class="ri-chat-smile-2-line text-5xl text-gray-200"></i></div><p class="text-gray-400 text-sm">No messages yet. Say hello!</p></div>';
          }
        } catch (err) {
          console.error('Failed to load history:', err);
          loadingMessages.innerHTML = '<p class="text-red-500 text-sm">Failed to load messages</p>';
        }
      }
      loadHistory();

      // ── Render a message bubble ──
      function appendMessage(msg, animate) {
        const isMine = (msg.senderId._id || msg.senderId) === currentUserId;
        const wrapper = document.createElement('div');
        wrapper.className = 'flex mb-2 ' + (isMine ? 'justify-end' : 'justify-start');
        if (animate) {
          wrapper.style.opacity = '0';
          wrapper.style.transform = 'translateY(8px)';
          wrapper.style.transition = 'all 0.25s ease';
        }

        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble px-4 py-2 ' + (isMine ? 'msg-sent' : 'msg-received');
        bubble.setAttribute('data-message-id', msg._id);

        const text = document.createElement('p');
        text.className = 'text-sm whitespace-pre-wrap';
        text.textContent = msg.text;

        const meta = document.createElement('div');
        meta.className = 'flex items-center justify-end gap-1 mt-1';

        const time = document.createElement('span');
        time.className = 'text-[10px] ' + (isMine ? 'text-white/60' : 'text-gray-400');
        const d = new Date(msg.createdAt);
        time.textContent = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        meta.appendChild(time);

        // Ticks for sent messages
        if (isMine) {
          const tick = document.createElement('span');
          tick.className = 'tick tick-' + (msg.status || 'sent');
          tick.setAttribute('data-tick-id', msg._id);
          tick.innerHTML = getTickHTML(msg.status || 'sent');
          meta.appendChild(tick);
        }

        bubble.appendChild(text);
        bubble.appendChild(meta);
        wrapper.appendChild(bubble);
        chatMessages.appendChild(wrapper);

        if (animate) {
          requestAnimationFrame(function() {
            wrapper.style.opacity = '1';
            wrapper.style.transform = 'translateY(0)';
          });
        }
      }

      function getTickHTML(status) {
        if (status === 'read') {
          return '<i class="ri-check-double-line text-blue-400"></i>';
        } else if (status === 'delivered') {
          return '<i class="ri-check-double-line" style="color:rgba(255,255,255,0.7)"></i>';
        }
        return '<i class="ri-check-line" style="color:rgba(255,255,255,0.5)"></i>';
      }

      function appendDateSeparator(dateStr) {
        const sep = document.createElement('div');
        sep.className = 'flex justify-center my-4';
        sep.innerHTML = '<span class="bg-gray-200 text-gray-500 text-xs px-3 py-1 rounded-full">' + dateStr + '</span>';
        chatMessages.appendChild(sep);
      }

      function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // ── Receive new message from socket ──
      socket.on('newMessage', function(msg) {
        const senderId = msg.senderId._id || msg.senderId;
        const isMine = senderId === currentUserId;

        // Avoid duplicates
        if (document.querySelector('[data-message-id="' + msg._id + '"]')) return;

        appendMessage(msg, true);
        scrollToBottom();

        // If message is from other user, auto-deliver + read
        if (!isMine) {
          socket.emit('messageDelivered', { messageId: msg._id, conversationId: conversationId });
          
          // If window is focused, mark as read immediately
          if (document.hasFocus()) {
            socket.emit('messageRead', { conversationId: conversationId });
          }
        }
      });

      // ── Update tick status ──
      socket.on('updateMessageStatus', function(data) {
        const tickEl = document.querySelector('[data-tick-id="' + data.messageId + '"]');
        if (tickEl) {
          tickEl.className = 'tick tick-' + data.status;
          tickEl.innerHTML = getTickHTML(data.status);
        }
      });

      // ── Bulk read update ──
      socket.on('bulkMessageRead', function(data) {
        if (data.readBy !== currentUserId) {
          // The other user read our messages – update all ticks
          document.querySelectorAll('.tick-sent, .tick-delivered').forEach(function(el) {
            el.className = 'tick tick-read';
            el.innerHTML = getTickHTML('read');
          });
        }
      });

      // ── Send message ──
      messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;

        sendBtn.disabled = true;
        socket.emit('sendMessage', { conversationId: conversationId, text: text }, function(resp) {
          if (resp && resp.error) {
            alert('Failed to send: ' + resp.error);
          }
          messageInput.value = '';
          messageInput.style.height = 'auto';
          updateSendBtn();
          messageInput.focus();
        });
      });

      // ── Enable/disable send button ──
      function updateSendBtn() {
        sendBtn.disabled = !messageInput.value.trim();
      }
      messageInput.addEventListener('input', function() {
        updateSendBtn();
        // Auto-resize textarea
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 128) + 'px';
      });

      // ── Enter to send, Shift+Enter for newline ──
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          messageForm.dispatchEvent(new Event('submit'));
        }
      });

      // ── Typing indicators ──
      let typingTimeout = null;
      messageInput.addEventListener('input', function() {
        socket.emit('typing', { conversationId: conversationId });
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(function() {
          socket.emit('stopTyping', { conversationId: conversationId });
        }, 2000);
      });

      socket.on('userTyping', function(data) {
        if (data.userId !== currentUserId) {
          typingIndicator.classList.remove('hidden');
          scrollToBottom();
        }
      });

      socket.on('userStopTyping', function(data) {
        if (data.userId !== currentUserId) {
          typingIndicator.classList.add('hidden');
        }
      });

      // ── Mark read when window gains focus ──
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          socket.emit('messageRead', { conversationId: conversationId });
        }
      });
      window.addEventListener('focus', function() {
        socket.emit('messageRead', { conversationId: conversationId });
      });

      // ── Cleanup on leave ──
      window.addEventListener('beforeunload', function() {
        socket.emit('leaveConversation', conversationId);
      });
    })();
  </script>
</body>

</html>
